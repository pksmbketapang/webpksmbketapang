<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/basscss@8.0.2/css/basscss.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
    <title>QC</title>
</head>
<body class="clearfix mxn1">
    <div class="col col-12 mb2 px1">
        <canvas id="qcmain" height="500" width="500" class="mx-auto"></canvas>
    </div>
    <div class="col col-6 mb1 px1">
        <p id="tidakSah" class="h3 bold center m0 p2" style="color: white; background-color: #ff5000; border-radius: 10px;">Suara tidak sah: 0%</p>
    </div>
    <div class="col col-6 mb1 px1">
        <p id="dataMasuk" class="h3 bold center m0 p2" style="color: white; background-color: #ff5000; border-radius: 10px;">Data masuk: 0%</p>
    </div>
    <div class="col col-12 mb1 px1">
        <p id="partisipasi" class="h3 bold center m0 p2" style="color: white; background-color: #ff5000; border-radius: 10px;">Partisipasi pemilih: 0%</p>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
    <script>
        const SHEET_PROSENTASE = 'https://gsx2json.com/api?id=1aTvUiXZ_rqyjyXCJWAkl4xf_zdE4K79rCDPYnt94Ymw&sheet=1&columns=false'
        const SHEET_DATA = 'https://gsx2json.com/api?id=1aTvUiXZ_rqyjyXCJWAkl4xf_zdE4K79rCDPYnt94Ymw&sheet=2&columns=false'
        $.getJSON(SHEET_PROSENTASE, data => {
            let labels = []
            let numbers = []
            let colors = []
            data.rows.forEach(e => {
                labels.push(`0${e['nopasangan']} - ${e['sloganpasangan']}`)
                numbers.push(Number(e['perolehansuara']))
                colors.push(e['colorcode'])
            })
            let qcMainCtx = document.getElementById('qcmain').getContext('2d')
            let qcMainChart = new Chart(qcMainCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        data: numbers,
                        datalabels: {
                            color: '#ffffff',
                            anchor: 'center',
                            textAlign: 'center',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }]
                },

                options: {
                    plugins: {
                        datalabels: {
                            formatter: function(value, ctx) {
                                let sum = 0
                                let allData = ctx.chart.data.datasets[0].data
                                allData.map(data => {
                                    sum += data
                                })
                                let percentage = (value * 100 / sum).toFixed(2) + "%"
                                return [percentage]
                            }
                        }
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            },
                            offset: true
                        }],
                        xAxes: [{
                            offset: true
                        }]
                    },
                    tooltips: {
                        enabled: false
                    },
                    animation: {
                        duration: 1000
                    },
                    legend: {
                        display: false,
                    }
                }
            })
            setInterval(function() {
                labels = []
                numbers = []
                $.getJSON(SHEET_PROSENTASE, data => {
                    data.rows.forEach(e => {
                        labels.push(`0${e['nopasangan']} - ${e['sloganpasangan']}`)
                        numbers.push(Number(e['perolehansuara']))
                    })
                    qcMainChart.data.datasets[0].data = numbers
                    qcMainChart.update()
                })
                $.getJSON(SHEET_DATA, data => {
                    $('#tidakSah').fadeOut(400, function() {
                        let persenTidakSah = (data.rows[1].value * 100 / data.rows[2].value).toFixed(2)
                        $(this).text("Suara tidak sah: " + persenTidakSah + "%").fadeIn(400)
                    })
                    $('#dataMasuk').fadeOut(400, function() {
                        let persenData = (data.rows[0].value * 100 / 893).toFixed(2)
                        $(this).text("Data masuk: " + persenData + "%").fadeIn(400)
                    })
                    $('#partisipasi').fadeOut(400, function() {
                        let persenPartisipasi = (data.rows[2].value * 100 / 265270).toFixed(2)
                        $(this).text("Partisipasi pemilih: " + persenPartisipasi + "%").fadeIn(400)
                    })
                })
                
            }, 15000)
        })
    </script>
</body>
</html>