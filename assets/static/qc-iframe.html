<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Count IFrame</title>
</head>
<body>
    <canvas id="qcmain" height="300" width="400"></canvas>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
    <script>
        const SHEET_PROSENTASE = 'https://gsx2json.com/api?id=1aTvUiXZ_rqyjyXCJWAkl4xf_zdE4K79rCDPYnt94Ymw&sheet=1&columns=false'
        const SHEET_DATA = 'https://gsx2json.com/api?id=1aTvUiXZ_rqyjyXCJWAkl4xf_zdE4K79rCDPYnt94Ymw&sheet=2&columns=false'
        $.getJSON(SHEET_PROSENTASE, data => {
            let labels = []
            let numbers = []
            let colors = []
            data.rows.forEach(e => {
                labels.push(`0${e['nopasangan']} - ${e['sloganpasangan']}`)
                numbers.push(Number(e['perolehansuara']))
                colors.push(e['colorcode'])
            })
            let qcMainCtx = document.getElementById('qcmain').getContext('2d')
            let qcMainChart = new Chart(qcMainCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Perolehan Suara Pilkada Kab. Kotim 2020',
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        data: numbers,
                        datalabels: {
                            color: '#ffffff',
                            textAlign: 'center',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }]
                },

                options: {
                    plugins: {
                        datalabels: {
                            formatter: function(value, ctx) {
                                let sum = 0
                                let allData = ctx.chart.data.datasets[0].data
                                allData.map(data => {
                                    sum += data
                                })
                                let percentage = (value * 100 / sum).toFixed(2) + "%"
                                return [ctx.chart.data.labels[ctx.dataIndex], percentage]
                            }
                        }
                    },
                    layout: {
                        padding: 50
                    },
                    scales: {},
                    tooltips: {
                        enabled: false
                    },
                    animation: {
                        duration: 1000
                    },
                    legend: {
                        display: false
                    }
                }
            })
            setInterval(function() {
                labels = []
                numbers = []
                $.getJSON(SHEET_PROSENTASE, data => {
                    data.rows.forEach(e => {
                        labels.push(`0${e['nopasangan']} - ${e['sloganpasangan']}`)
                        numbers.push(Number(e['perolehansuara']))
                    })
                    qcMainChart.data.datasets[0].data = numbers
                    qcMainChart.update()
                })
            }, 30000)
        })
    </script>
</body>
</html>